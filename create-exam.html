<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Exam - Sankalp Shiksha</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .exam-creator {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .creator-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .creator-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        
        .step.active .step-circle {
            background: #2a8bf2;
            color: white;
        }
        
        .step.completed .step-circle {
            background: #28a745;
            color: white;
        }
        
        .creator-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .question-bank {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .question-item {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .question-item:hover {
            border-color: #2a8bf2;
            background: rgba(42, 139, 242, 0.05);
        }
        
        .question-item.selected {
            border-color: #2a8bf2;
            background: rgba(42, 139, 242, 0.1);
        }
        
        .selected-questions {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            margin-top: 20px;
        }
        
        .selected-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .preview-section {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .creator-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .counter-badge {
            background: #2a8bf2;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .question-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>Sankalp Shiksha</span>
            </div>
            <div class="nav-menu">
                <a href="teacher-dashboard.html" class="nav-link">Dashboard</a>
                <a href="create-exam.html" class="nav-link active">Create Exam</a>
                <a href="question-bank.html" class="nav-link">Question Bank</a>
                <a href="#" class="nav-link">Results</a>
                <a href="#" class="btn btn-outline" data-logout>Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="exam-creator">
        <div class="creator-header">
            <h1>Create New Exam</h1>
            <p>Follow the steps to create your custom exam</p>
        </div>
        
        <div class="creator-steps">
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <span>Basic Info</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <span>Add Questions</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <span>Settings</span>
            </div>
            <div class="step" data-step="4">
                <div class="step-circle">4</div>
                <span>Preview & Publish</span>
            </div>
        </div>
        
        <div class="creator-content">
            <!-- Step 1: Basic Info -->
            <div id="step1" class="step-content active">
                <h2>Basic Exam Information</h2>
                <form id="basicInfoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Exam Title</label>
                            <input type="text" class="form-control" id="examTitle" required 
                                   placeholder="e.g., Class 10 Mathematics Midterm">
                        </div>
                        <div class="form-group">
                            <label>Subject</label>
                            <select class="form-control" id="examSubject" required>
                                <option value="">Select Subject</option>
                                <option value="mathematics">Mathematics</option>
                                <option value="science">Science</option>
                                <option value="english">English</option>
                                <option value="hindi">Hindi</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Class/Grade</label>
                            <select class="form-control" id="examClass" required>
                                <option value="">Select Class</option>
                                <option value="9">Class 9</option>
                                <option value="10">Class 10</option>
                                <option value="11">Class 11</option>
                                <option value="12">Class 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Total Marks</label>
                            <input type="number" class="form-control" id="totalMarks" 
                                   min="1" max="500" value="100" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" class="form-control" id="examDuration" 
                                   min="10" max="300" value="120" required>
                        </div>
                        <div class="form-group">
                            <label>Exam Date</label>
                            <input type="date" class="form-control" id="examDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Instructions</label>
                        <textarea class="form-control" id="examInstructions" rows="4" 
                                  placeholder="Add exam instructions for students..."></textarea>
                    </div>
                </form>
            </div>
            
            <!-- Step 2: Add Questions -->
            <div id="step2" class="step-content">
                <h2>Select Questions <span id="selectedCount" class="counter-badge">0</span></h2>
                
                <div class="question-filter">
                    <select class="filter-select" id="filterSubject">
                        <option value="">All Subjects</option>
                        <option value="mathematics">Mathematics</option>
                        <option value="science">Science</option>
                    </select>
                    
                    <select class="filter-select" id="filterDifficulty">
                        <option value="">All Difficulty</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                    
                    <select class="filter-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="mcq">Multiple Choice</option>
                        <option value="true_false">True/False</option>
                    </select>
                    
                    <button class="btn btn-outline" id="clearFilters">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
                
                <div class="question-bank" id="questionBank">
                    <!-- Questions will be loaded here -->
                </div>
                
                <div class="selected-questions">
                    <h3>Selected Questions</h3>
                    <div id="selectedQuestionsList">
                        <!-- Selected questions will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Settings -->
            <div id="step3" class="step-content">
                <h2>Exam Settings</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shuffleQuestions" checked>
                            Shuffle Questions
                        </label>
                        <small>Randomize question order for each student</small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shuffleOptions" checked>
                            Shuffle Options
                        </label>
                        <small>Randomize answer options</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableNegative">
                            Enable Negative Marking
                        </label>
                        <small>Deduct marks for wrong answers</small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showResults">
                            Show Results Immediately
                        </label>
                        <small>Display results after submission</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Allowed Attempts</label>
                        <select class="form-control" id="allowedAttempts">
                            <option value="1">1 Attempt</option>
                            <option value="2">2 Attempts</option>
                            <option value="3">3 Attempts</option>
                            <option value="unlimited">Unlimited</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Passing Percentage</label>
                        <input type="number" class="form-control" id="passingPercent" 
                               min="0" max="100" value="40">
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Preview -->
            <div id="step4" class="step-content">
                <h2>Preview & Publish</h2>
                
                <div class="preview-section">
                    <h3 id="previewTitle">Exam Title</h3>
                    <div class="preview-details">
                        <p><strong>Subject:</strong> <span id="previewSubject">Mathematics</span></p>
                        <p><strong>Class:</strong> <span id="previewClass">Class 10</span></p>
                        <p><strong>Duration:</strong> <span id="previewDuration">120 minutes</span></p>
                        <p><strong>Total Marks:</strong> <span id="previewMarks">100</span></p>
                        <p><strong>Questions:</strong> <span id="previewQuestions">0</span></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Publish Status</label>
                        <select class="form-control" id="publishStatus">
                            <option value="draft">Save as Draft</option>
                            <option value="published">Publish Now</option>
                            <option value="scheduled">Schedule for Later</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="creator-actions">
            <button class="btn btn-outline" id="prevStep">
                <i class="fas fa-arrow-left"></i> Previous
            </button>
            
            <div>
                <button class="btn btn-outline" id="saveDraft">
                    <i class="fas fa-save"></i> Save Draft
                </button>
                <button class="btn btn-primary" id="nextStep">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button class="btn btn-success" id="publishExam" style="display: none;">
                    <i class="fas fa-paper-plane"></i> Publish Exam
                </button>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/question-set.js"></script>
    <script src="js/exam-manager.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 4;
        const selectedQuestions = [];
        
        // Initialize date picker to today
        document.getElementById('examDate').valueAsDate = new Date();
        
        // Step navigation
        document.getElementById('nextStep').addEventListener('click', function() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (validateStep(currentStep)) {
                    navigateToStep(currentStep + 1);
                }
            }
        });
        
        document.getElementById('prevStep').addEventListener('click', function() {
            if (currentStep > 1) {
                navigateToStep(currentStep - 1);
            }
        });
        
        document.getElementById('publishExam').addEventListener('click', function() {
            if (validateStep(4)) {
                saveExam();
            }
        });
        
        function navigateToStep(step) {
            // Update steps UI
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active', 'completed');
                if (parseInt(s.dataset.step) < step) {
                    s.classList.add('completed');
                }
            });
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
            
            // Update buttons
            document.getElementById('prevStep').style.display = step === 1 ? 'none' : 'inline-flex';
            document.getElementById('nextStep').style.display = step === totalSteps ? 'none' : 'inline-flex';
            document.getElementById('publishExam').style.display = step === totalSteps ? 'inline-flex' : 'none';
            
            // Load data for step
            if (step === 2) {
                loadQuestionBank();
            } else if (step === 4) {
                updatePreview();
            }
        }
        
        function validateStep(step) {
            switch(step) {
                case 1:
                    const title = document.getElementById('examTitle').value;
                    const subject = document.getElementById('examSubject').value;
                    if (!title || !subject) {
                        alert('Please fill all required fields');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (selectedQuestions.length === 0) {
                        alert('Please select at least one question');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }
        
        function loadQuestionBank() {
            const bank = document.getElementById('questionBank');
            bank.innerHTML = '';
            
            const questions = window.QuestionDatabase.questions;
            
            questions.forEach(question => {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${question.question}</strong>
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <span class="badge badge-primary">${question.subject}</span>
                                <span class="badge badge-${question.difficulty}">${question.difficulty}</span>
                                <span class="badge badge-secondary">${question.type}</span>
                                <span class="badge badge-warning">${question.marks} marks</span>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary add-question-btn" 
                                data-id="${question.id}">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                `;
                bank.appendChild(div);
            });
            
            // Add event listeners to add buttons
            document.querySelectorAll('.add-question-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.dataset.id;
                    addQuestion(questionId);
                });
            });
        }
        
        function addQuestion(questionId) {
            const question = window.QuestionDatabase.getQuestionById(questionId);
            if (!selectedQuestions.find(q => q.id === questionId)) {
                selectedQuestions.push(question);
                updateSelectedQuestions();
            }
        }
        
        function updateSelectedQuestions() {
            const list = document.getElementById('selectedQuestionsList');
            const count = document.getElementById('selectedCount');
            
            list.innerHTML = '';
            count.textContent = selectedQuestions.length;
            
            selectedQuestions.forEach((question, index) => {
                const div = document.createElement('div');
                div.className = 'selected-question';
                div.innerHTML = `
                    <div>
                        <strong>${index + 1}. ${question.question.substring(0, 50)}...</strong>
                        <div style="font-size: 12px; color: #666;">
                            ${question.subject} | ${question.difficulty} | ${question.marks} marks
                        </div>
                    </div>
                    <button class="btn btn-sm btn-danger remove-question" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                list.appendChild(div);
            });
            
            // Add remove event listeners
            document.querySelectorAll('.remove-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    selectedQuestions.splice(index, 1);
                    updateSelectedQuestions();
                });
            });
        }
        
        function updatePreview() {
            document.getElementById('previewTitle').textContent = 
                document.getElementById('examTitle').value;
            document.getElementById('previewSubject').textContent = 
                document.getElementById('examSubject').value;
            document.getElementById('previewClass').textContent = 
                'Class ' + document.getElementById('examClass').value;
            document.getElementById('previewDuration').textContent = 
                document.getElementById('examDuration').value + ' minutes';
            document.getElementById('previewMarks').textContent = 
                document.getElementById('totalMarks').value;
            document.getElementById('previewQuestions').textContent = 
                selectedQuestions.length;
        }
        
        function saveExam() {
            const examData = {
                title: document.getElementById('examTitle').value,
                subject: document.getElementById('examSubject').value,
                class: document.getElementById('examClass').value,
                totalMarks: document.getElementById('totalMarks').value,
                duration: document.getElementById('examDuration').value,
                date: document.getElementById('examDate').value,
                instructions: document.getElementById('examInstructions').value,
                questions: selectedQuestions,
                settings: {
                    shuffleQuestions: document.getElementById('shuffleQuestions').checked,
                    shuffleOptions: document.getElementById('shuffleOptions').checked,
                    enableNegative: document.getElementById('enableNegative').checked,
                    showResults: document.getElementById('showResults').checked,
                    allowedAttempts: document.getElementById('allowedAttempts').value,
                    passingPercent: document.getElementById('passingPercent').value
                },
                status: document.getElementById('publishStatus').value,
                createdBy: window.AuthSystem.currentUser?.id || 'teacher',
                createdAt: new Date().toISOString()
            };
            
            // Save to localStorage
            const exams = JSON.parse(localStorage.getItem('sankalp_exams') || '[]');
            examData.id = 'EXAM' + Date.now().toString().slice(-6);
            exams.push(examData);
            localStorage.setItem('sankalp_exams', JSON.stringify(exams));
            
            alert('Exam saved successfully!');
            window.location.href = 'teacher-dashboard.html';
        }
        
        // Filter questions
        document.getElementById('clearFilters').addEventListener('click', function() {
            document.getElementById('filterSubject').value = '';
            document.getElementById('filterDifficulty').value = '';
            document.getElementById('filterType').value = '';
            loadQuestionBank();
        });
        
        // Save draft
        document.getElementById('saveDraft').addEventListener('click', function() {
            // Similar to publish but with draft status
            alert('Draft saved successfully!');
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const user = window.AuthSystem.currentUser;
            if (!user || (user.role !== 'teacher' && user.role !== 'admin')) {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
